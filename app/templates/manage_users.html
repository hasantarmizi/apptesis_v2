<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Manajemen Pengguna - Riasec Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm p-3 mb-4">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="{{ url_for('admin.dashboard_admin') }}">
      <img src="{{ url_for('static', filename='img/logo.png') }}" height="35" style="margin-right:6px;">
      Riasec Explorer
    </a>
    <div class="d-flex ms-auto align-items-center gap-3">
      <form class="d-flex" method="get" action="{{ url_for('admin.manage_users') }}">
        <input name="q" value="{{ q }}" class="form-control form-control-sm me-2" type="search" placeholder="Cari username atau role..." aria-label="Search">
        <button class="btn btn-sm btn-primary" type="submit">Cari</button>
      </form>
      <!-- Kembali: jika ada parameter next (dikirim dari halaman sebelumnya), gunakan itu; jika tidak, kembali ke dashboard -->
      <a class="btn btn-sm btn-secondary" href="{{ request.args.get('next') or url_for('admin.dashboard_admin') }}">Kembali</a>
      <a class="btn btn-sm btn-outline-danger" href="{{ url_for('auth.logout') }}">Logout</a>
    </div>
  </div>
</nav>

<div class="container">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, msg in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else ('warning' if category=='warning' else 'danger') }}">
            {{ msg }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Manajemen Pengguna</h4>
    <a class="btn btn-sm btn-primary" href="#" data-bs-toggle="modal" data-bs-target="#modalCreateUser">Buat Pengguna Baru</a>
  </div>

  <div class="card p-3">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Username</th>
            <th>Role</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ loop.index + ((pagination.page-1) * pagination.per_page) }}</td>
            <td>{{ u.username }}</td>
            <td>{{ u.role }}</td>
            <td>
              <!-- Reset password form -->
              <form method="post" action="{{ url_for('admin.reset_user_password', user_id=u.id) }}" style="display:inline-block">
                <input type="hidden" name="default_password" value="123456">
                <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('Reset password pengguna {{ u.username }} ke default 123456?')">Reset Password</button>
              </form>

              <!-- Delete user form -->
              <form method="post" action="{{ url_for('admin.delete_user', user_id=u.id) }}" style="display:inline-block" onsubmit="return confirm('Hapus pengguna {{ u.username }}? Tindakan ini tidak dapat dibatalkan.')">
                <button type="submit" class="btn btn-sm btn-danger">Hapus</button>
              </form>
            </td>
          </tr>
          {% endfor %}
          {% if users|length == 0 %}
          <tr><td colspan="4" class="text-center text-muted">Tidak ada pengguna.</td></tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    {% if pagination and pagination.pages > 1 %}
    <div class="mt-3 d-flex justify-content-end gap-2">
      {% if pagination.has_prev %}
      <a href="{{ url_for('admin.manage_users', q=q, page=pagination.prev_num) }}" class="btn btn-sm btn-outline-secondary">Prev</a>
      {% endif %}
      {% for p in range(1, pagination.pages + 1) %}
        {% if p == pagination.page %}
        <span class="btn btn-sm btn-primary">{{ p }}</span>
        {% else %}
        <a href="{{ url_for('admin.manage_users', q=q, page=p) }}" class="btn btn-sm btn-outline-secondary">{{ p }}</a>
        {% endif %}
      {% endfor %}
      {% if pagination.has_next %}
      <a href="{{ url_for('admin.manage_users', q=q, page=pagination.next_num) }}" class="btn btn-sm btn-outline-secondary">Next</a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="modalCreateUser" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form method="post" action="{{ url_for('admin.create_user') }}" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Buat Pengguna</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Role</label>
          <select id="createUserRole" name="role" class="form-select" required>
            <option value="guru">Guru</option>
            <option value="siswa">Siswa</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label">Nama (opsional)</label>
          <input name="nama" class="form-control">
        </div>
        <div class="mb-2" id="field-nisn" style="display:none;">
          <label class="form-label">NISN (untuk role siswa)</label>
          <input name="nisn" class="form-control">
        </div>
        <div class="mb-2" id="field-kelas" style="display:none;">
          <label class="form-label">Kelas (opsional)</label>
          <input name="kelas" class="form-control">
        </div>
        <div class="mb-2">
          <label class="form-label">Username</label>
          <input name="username" class="form-control" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Password</label>
          <input name="password" type="password" class="form-control" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Buat</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function(){
  const roleSelect = document.getElementById('createUserRole');
  const fieldNisn = document.getElementById('field-nisn');
  const fieldKelas = document.getElementById('field-kelas');
  function toggleFields(){
    if(!roleSelect) return;
    if(roleSelect.value === 'siswa'){
      fieldNisn.style.display = '';
      fieldKelas.style.display = '';
    } else {
      fieldNisn.style.display = 'none';
      fieldKelas.style.display = 'none';
    }
  }
  if(roleSelect){
    roleSelect.addEventListener('change', toggleFields);
    toggleFields();
  }
});
</script>
</body>
</html>