<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Dashboard Admin — Riasec Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --card-radius: 12px;
      --muted: #6b7280;
      --accent: #167bfa;
      --bg: #f6f9fb;
    }
    body { background: var(--bg); font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; color: #111827; }
    .page-wrap { padding: 22px 28px; max-width:1200px; margin:0 auto; }

    /* top nav minimal */
    .topbar { height:64px; display:flex; align-items:center; gap:16px; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:700; font-size:18px; }
    .brand img{ height:28px; }

    /* summary cards row */
    .summary-row { display:flex; gap:18px; margin:18px 0; align-items:stretch; }
    .card-sum {
      flex:1;
      background:#fff;
      border-radius:var(--card-radius);
      padding:18px 22px;
      box-shadow:0 6px 18px rgba(15,23,42,0.04);
      border:1px solid rgba(15,23,42,0.03);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      min-height:86px;
    }
    .card-sum .value { font-size:28px; font-weight:700; color:#0f172a; }
    .card-sum .label { color:var(--muted); font-size:13px; margin-top:6px; }

    /* Main content: left big panel + right aside */
    .content { display:grid; grid-template-columns: 1fr 260px; gap:18px; align-items:start; }

    .panel {
      background:#fff;
      border-radius:var(--card-radius);
      padding:18px;
      box-shadow:0 6px 18px rgba(15,23,42,0.04);
      border:1px solid rgba(15,23,42,0.03);
    }

    /* donut + legend */
    .donut-wrap { display:flex; gap:18px; align-items:center; }
    .donut-canvas { width:280px; height:280px; flex:0 0 280px; }
    .donut-legend { flex:1; padding-left:6px; }
    .legend-item { display:flex; align-items:center; gap:12px; margin:10px 0; font-weight:600; color:#0f172a; }
    .legend-color { width:14px; height:14px; border-radius:6px; display:inline-block; }

    .subtle { color:var(--muted); font-size:14px; margin-top:6px; }

    /* right action box */
    .aside-actions .btn { width:100%; text-align:left; display:flex; gap:10px; align-items:center; }
    .aside-actions .btn i { font-size:18px; margin-right:6px; }

    /* filters row above table */
    .filters { display:flex; gap:10px; justify-content:flex-end; align-items:center; margin-top:12px; }

    /* students table */
    .table-card { margin-top:16px; overflow:hidden; }
    table.data-table thead th { background:#f3f6f9; border-bottom:0; font-weight:700; color:#111827; }
    .badge-paket { padding:6px 10px; border-radius:8px; font-weight:700; color:#fff; font-size:13px; display:inline-block; }
    .badge-p1 { background:#167bfa; }
    .badge-p2 { background:#3cb4fa; }
    .badge-p3 { background:#ff6b6b; }
    .badge-none { background:#94a3b8; color:#fff; padding:6px 10px; border-radius:8px; font-weight:700; font-size:13px; }

    /* table action buttons */
    .action-btns .btn { margin-right:6px; }

    /* pagination small */
    .small-pager { display:flex; gap:8px; align-items:center; color:var(--muted); }

    /* responsive */
    @media (max-width: 991px){
      .content { grid-template-columns: 1fr; }
      .aside-actions { order:2; }
      .donut-canvas { width:210px; height:210px; flex:0 0 210px; }
      .summary-row { flex-wrap:wrap; }
    }
  </style>
</head>
<body>
  <div class="page-wrap">
    <div class="topbar">
      <div class="brand">
        <img src="{{ url_for('static', filename='img/logo.png') }}" alt="logo">
        Riasec Explorer
      </div>
      <div class="ms-auto d-none d-md-flex align-items-center" style="gap:18px">
        <a class="text-muted" href="{{ url_for('admin.dashboard_admin') }}">Beranda</a>
        <a class="text-muted" href="{{ url_for('auth.logout') }}">Logout</a>
      </div>
    </div>

    <!-- SUMMARY -->
    <div class="summary-row">
      <div class="card-sum">
        <div class="value">{{ total_siswa }}</div>
        <div class="label">Total Siswa</div>
      </div>
      <div class="card-sum">
        <div class="value">{{ total_guru }}</div>
        <div class="label">Total Guru</div>
      </div>
      <div class="card-sum">
        <div class="value">{{ siswa_sudah_tes }}</div>
        <div class="label">Siswa Sudah Tes</div>
      </div>
      <div class="card-sum">
        <div class="value">
          {%- set belum = (total_siswa - siswa_sudah_tes) if (total_siswa is not none and siswa_sudah_tes is not none) else "-" -%}
          {{ belum }}
        </div>
        <div class="label">Belum Tes</div>
      </div>
    </div>

    <div class="content">
      <!-- LEFT: main panels -->
      <div>

        <!-- Donut / Distribusi panel -->
        <div class="panel mb-3">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="mb-1">Distribusi Paket Rekomendasi</h5>
              <div class="subtle">Berdasarkan {{ siswa_sudah_tes }} siswa yang sudah tes</div>
            </div>
            <div class="d-flex gap-2">
              <!-- Filter form: hanya status (kelas dihapus) -->
              
            </div>
          </div>

          <div class="donut-wrap mt-3">
            <div class="donut-canvas">
              <canvas id="donutChart"></canvas>
            </div>
            <div class="donut-legend">
              <div class="legend-item"><span class="legend-color" style="background:#167bfa"></span> Paket 1 <span class="ms-2 text-muted"> {{ paket1_pct }}%</span></div>
              <div class="legend-item"><span class="legend-color" style="background:#3cb4fa"></span> Paket 2 <span class="ms-2 text-muted"> {{ paket2_pct }}%</span></div>
              <div class="legend-item"><span class="legend-color" style="background:#ff6b6b"></span> Paket 3 <span class="ms-2 text-muted"> {{ paket3_pct }}%</span></div>

              <div class="mt-3 subtle">Total: <strong>{{ siswa_sudah_tes }} siswa</strong></div>
            </div>
          </div>
        </div>

        <!-- Students table panel -->
        <div class="panel table-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-0">Data Siswa</h5>
              <div class="subtle">Menampilkan {{ data_siswa|length }} hasil{% if total_siswa is defined %} dari {{ total_siswa }} data{% endif %}</div>
            </div>
            <div class="filters">
              <!-- Filter form di tabel: only status -->
              <form method="get" action="{{ url_for('admin.dashboard_admin') }}" class="d-flex align-items-center" style="gap:10px;">
                <input type="hidden" name="q" value="{{ q }}">
                <select name="status" class="form-select form-select-sm" style="width:180px;" onchange="this.form.submit()">
                  <option value="semua" {{ 'selected' if status=='semua' else '' }}>Status Tes: Semua</option>
                  <option value="sudah" {{ 'selected' if status=='sudah' else '' }}>Sudah Tes</option>
                  <option value="belum" {{ 'selected' if status=='belum' else '' }}>Belum Tes</option>
                </select>
                <noscript><button class="btn btn-primary btn-sm">Cari</button></noscript>
              </form>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table data-table align-middle">
              <thead>
                <tr>
                  <th style="width:160px">NISN</th>
                  <th>Nama Siswa</th>
                  <th style="width:140px">Kelas</th>
                  <th style="width:140px">Hasil Tes RIASEC</th>
                  <th style="width:160px">Paket Rekomendasi</th>
                  <th style="width:200px">Aksi</th>
                </tr>
              </thead>
              <tbody>
                {% for s in data_siswa %}
                <tr>
                  <td class="text-muted">{{ s.nisn }}</td>
                  <td><strong>{{ s.nama }}</strong></td>
                  <td class="text-muted">{{ s.kelas if s.kelas else '-' }}</td>
                  <td class="text-muted">{{ s.kode_riasec if s.kode_riasec else '-' }}</td>
                  <td>
                    {% if s.paket and s.paket != '-' %}
                      {%- if '1' in s.paket -%}
                        <span class="badge-paket badge-p1">Paket 1</span>
                      {%- elif '2' in s.paket -%}
                        <span class="badge-paket badge-p2">Paket 2</span>
                      {%- else -%}
                        <span class="badge-paket badge-p3">{{ s.paket }}</span>
                      {%- endif -%}
                    {% else %}
                      <span class="badge-none">Belum Tes</span>
                    {% endif %}
                  </td>
                  <td class="action-btns">
                    <a href="{{ url_for('admin.siswa_detail', nisn=s.nisn, next=request.full_path) }}" class="btn btn-sm btn-primary"><i class="bi bi-eye"></i> Lihat</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="small-pager">1 - {{ data_siswa|length }} dari {{ total_siswa }} data</div>
            <div>
              {% if pagination and pagination.pages > 1 %}
                <nav aria-label="Page navigation">
                  <ul class="pagination pagination-sm mb-0">
                    {% if pagination.has_prev %}
                      <li class="page-item"><a class="page-link" href="{{ url_for('admin.dashboard_admin', page=pagination.prev_num, status=status, q=q) }}">‹</a></li>
                    {% else %}
                      <li class="page-item disabled"><span class="page-link">‹</span></li>
                    {% endif %}
                    {% for p in range(1, pagination.pages + 1) %}
                      <li class="page-item {{ 'active' if p == pagination.page else '' }}">
                        <a class="page-link" href="{{ url_for('admin.dashboard_admin', page=p, status=status, q=q) }}">{{ p }}</a>
                      </li>
                    {% endfor %}
                    {% if pagination.has_next %}
                      <li class="page-item"><a class="page-link" href="{{ url_for('admin.dashboard_admin', page=pagination.next_num, status=status, q=q) }}">›</a></li>
                    {% else %}
                      <li class="page-item disabled"><span class="page-link">›</span></li>
                    {% endif %}
                  </ul>
                </nav>
              {% endif %}
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT: quick actions -->
      <aside class="aside-actions">
        <div class="panel">
          <h6 class="mb-3">Aksi Cepat</h6>
          <div class="d-grid gap-2">
            <a href="{{ url_for('admin.manage_users') }}" class="btn btn-primary"><i class="bi bi-people"></i> Manajemen Pengguna</a>
            <a class="btn btn-warning text-dark" href="{{ url_for('admin.manage_questions') }}"><i class="bi bi-plus-lg"></i> Manajemen Pertanyaan RIASEC</a>
            <a class="btn btn-outline-secondary" href="{{ url_for('admin.download_csv', q=q, status=status) }}"><i class="bi bi-file-earmark-arrow-down"></i> Export Data</a>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal: (dihapus) Tambah Pertanyaan RIASEC dipindah ke halaman Manajemen Pertanyaan -->

  <!-- (Optional hidden trigger for Add Student from aside) -->
  <button id="modalAddStudentTrigger" class="d-none" data-bs-toggle="modal" data-bs-target="#modalCreateUser"></button>

  <!-- Create User Modal (reuse) -->
  <div class="modal fade" id="modalCreateUser" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="post" action="{{ url_for('admin.create_user') }}" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Buat Pengguna</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select id="createUserRole" name="role" class="form-select" required>
              <option value="siswa">Siswa</option>
              <option value="guru">Guru</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input name="username" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input name="password" type="password" class="form-control" required>
          </div>
          <div class="mb-3" id="field-nisn" style="display:block;">
            <label class="form-label">NISN (untuk siswa)</label>
            <input name="nisn" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary">Buat</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        </div>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Prepare donut data from server-side variables
    const paket1 = {{ paket1_pct|default(0) }};
    const paket2 = {{ paket2_pct|default(0) }};
    const paket3 = {{ paket3_pct|default(0) }};
    const total_sudah = {{ siswa_sudah_tes|default(0) }};

    const dataVals = [paket1, paket2, paket3];
    const colors = ['#167bfa', '#3cb4fa', '#ff6b6b'];

    // Chart center plugin (draw text)
    const centerTextPlugin = {
      id: 'centerText',
      afterDraw(chart, args, options) {
        const { ctx, chartArea: { width, height, left, top } } = chart;
        const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
        const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;
        ctx.save();
        ctx.fillStyle = '#0f172a';
        ctx.font = '700 26px Inter, Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        let txt = total_sudah ? (Math.round((paket3) * 10) / 10 + '%') : '0%';
        ctx.fillText(txt, centerX, centerY - 8);
        ctx.font = '500 12px Inter, Arial';
        ctx.fillStyle = '#6b7280';
        ctx.fillText(total_sudah + ' siswa', centerX, centerY + 18);
        ctx.restore();
      }
    };

    const ctx = document.getElementById('donutChart').getContext('2d');
    const donutChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Paket 1','Paket 2','Paket 3'],
        datasets: [{
          data: dataVals,
          backgroundColor: colors,
          hoverOffset: 6,
          borderWidth: 0
        }]
      },
      options: {
        cutout: '68%',
        plugins: {
          legend: { display: false }
        },
        maintainAspectRatio: false
      },
      plugins: [centerTextPlugin]
    });
  </script>
</body>
</html>